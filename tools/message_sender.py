import json
import re
from datetime import datetime

import json_repair
from aiogram.types import Message
from dotenv import load_dotenv
from aiogram import Bot, types
import asyncio
import os

from app.models import AnalysisDetail
from app.telegram.handlers.analysis import send_ok_message

def remove_control_characters_re(text):
    # Matches Unicode control characters in ranges U+0000-U+001F and U+007F-U+009F
    return re.sub(r'[\x00-\x1F\x7F-\x9F]', '', text)



async def main():
    load_dotenv()

    raw_str = str(
'{"score": 82, "strengths": ["Сильный релевантный опыт: 4+ года лидерской роли в облачной платформе (Kubernetes, сервисы, базы, брокеры) и 3+ года системной/десктоп-разработки с низкоуровневой экспертизой (USB, драйверы, macOS/Windows/Linux).", "Есть измеримые достижения: «ускорил Import/Export в 5 раз», сервис mesh на 5\u202f000 RPS, участие в архитектурном комитете, внедрение типизации и mypy.", "Технологический спектр Senior+/Principal: Python, Golang, FastAPI/aiohttp/Tornado, Kubernetes, Docker, MongoDB, Kafka/Redis, CI/CD, безопасность и аутентификация.", "Лидерские компетенции: управление командой backend и QA, планирование, код-ревью, развитие экспертизы; публичные выступления на PyCon, PHDays, подкасты.", "Хорошая доказательная база: публичные ссылки на доклады, GitHub, open-source вклады."], "problems": ["Слабая количественная конкретика по ключевым проектам: нет размеров команд («Руковожу командой…»), метрик по SLA/латентности/стоимости, влияния на бизнес.", "Эмодзи в тексте («🔧», «🏗», «🎥», «🥇») ухудшают ATS-парсинг и корпоративную читаемость.", "Опечатки и терминологические неточности: «Приемущетсвенно», «коммитета», «AurdiPilot», «LInux», «автоматиризованным», «OnPremise». Это снижает впечатление на уровне Lead/Principal.", "Формулировки общего характера: «Провожу временной анализ задач» — непонятна методика и точность оценки.", "Непоследовательность и потенциальная путаница: «Kubernetes as a Service (EKS)» в не-AWS продукте; «Service Mesh сервис» без указания технологий (Istio/Envoy/Linkerd).", "Ссылки местами битые/«зашумленные» параметрами («?si=...»), один фрагмент «si=3FJszjmqBt0BTH6R» попал в опыт — это ломает верстку.", "Навыки перечислены без структуры и уровней, есть разнобой в написании: «FastApi»/«FastAPI», «GitHubAction»/«GitHub Actions».", "Не хватает ключевых ATS-слов для позиции Lead/Principal: SLO/SLA, p95/p99, ADR/RFC, OKR, incident management, Terraform/Helm/Argo CD/OpenTelemetry и др.", "Раздел «Обо мне» перегружен хобби, нет ценности для принятия решения; GitHub указан без описания стека/якорных репозиториев.", "Высокая вилка (800\u202f000 ₽) может снизить отклики; без привязки к Москве/релокации/стоку выглядит жестко для фильтров."], "actions": ["Уберите эмодзи и выровняйте стиль. Пример: замените «🔧 Инструменты: ...» на «Стек: Python 3, FastAPI, aiohttp, Tornado, Golang, React, MongoDB, PostgreSQL, Kafka, Redis, Docker, Kubernetes, GitHub Actions».", "Добавьте размеры и контекст команды. Пример: замените «Руковожу командой backend разработчиков и QA» на «Руководил командой из 7 инженеров (5 backend, 2 QA), проводил 1:1 раз в 2 недели, отвечал за найм (N офферов/кв.), онбординг и план развития».", "Уточните метрики по ключевым сервисам и эффект для бизнеса. Пример: «Service Mesh: 5\u202f000 RPS, p95 35\u202fмс, 99,95% аптайм; снизили инциденты L3 с 5/кв. до 1/кв., ускорили выпуск фич на 20%».", "Конкретизируйте аутентификацию пользователей. Замените «Разработал сервис аутентификация пользователей…» на «Внедрил OAuth2/OIDC с короткоживущими токенами и секрет-less подходом (JWT/Rotating refresh), интеграция с Vault; удалили хранение пользовательских секретов в 7 сервисах».", "Исправьте неточности и опечатки: «Преимущественно» (вместо «Приемущетсвенно»), «комитета», «ArduPilot», «Linux», «автоматизированным», «on‑premise».", "Уберите привязку к EKS. Замените «Kubernetes as a Service (EKS)» на «Managed Kubernetes (K8s) с контролем кластера через CRD/Operators (controller‑runtime)» при необходимости, укажите технологии (Helm/Argo CD/Terraform).", "Сделайте сильные маркеры достижений с цифрами. Пример: «Import/Export: оптимизировал I/O (batched writes, async pipelines), ускорение в 5 раз (с 10 до 2 мин), снизил нагрузку на диски на 60%.»", "Уточните влияние инструментирования. Пример: «Внедрил типизацию Python + mypy (coverage 85%), сократил класс багов на ревью на 30%, время код-ревью — с 2,5 до 1,8 дня.»", "Поясните «On‑premise Copilot». Пример: «Развернул on‑premise code-assist (GitHub Copilot Enterprise/Tabnine Server), достигнут 25% ускорения шаблонного кода и снижения time‑to‑PR на 18%.»", "Пропишите CI/CD метрики. Пример: «GitHub Actions: кэширование/параллелизация, время пайплайна с 28 до 12 мин, MTTR релизов −40%, релизы через GitOps (Argo CD).»", "Emlid — добавьте численные результаты: «Burn‑In: одновременная проверка 120+ устройств, снижение брака с 3,2% до 1,1% за 2 кв.; порт macOS — охват пользователей +35%, Windows драйверы — WHQL/подпись (если была).»", "Очистите и стандартизируйте ссылки: уберите «?si=…», исправьте случайный «si=3FJszjmqBt0BTH6R» в тексте, оставьте короткие кликабельные URL и подпишите тему доклада (например: «PyCon Russia 2025 — Service Mesh в IaaS»).", "Нормализуйте навыки под ATS (через запятые, единый регистр): «Python, Golang, FastAPI, aiohttp, Tornado, AsyncIO, PostgreSQL, MongoDB, Kafka, Redis, gRPC, REST, OpenAPI, Docker, Kubernetes, Helm, Terraform, Argo CD, GitHub Actions, Prometheus, Grafana, ELK, OpenTelemetry, OAuth2, OIDC, JWT, Vault, Microservices, CQRS, Event‑driven, TDD, Pytest, MyPy, Pydantic, Clean Architecture, ADR, RFC, SLO/SLA, Incident Management, Scrum, Kanban».", "Замените общие фразы. Пример: «Провожу временной анализ задач…» на «Делаю оценку задач по методике story points/3‑point estimation, средняя точность спринтов ±12%, предсказуемость throughput — 92%».", "Сделайте «Обо мне» деловым: уберите хобби, добавьте 1–2 предложения о фокусе. Пример: «Инженер‑практик, специализация — высоконагруженные платформенные сервисы в облаке, интерес к reliability/observability/безопасности. Готов к собеседованию на английском (B2).»", "Перепроверьте раскладку/написания: «FastAPI», «GitHub Actions», «Qt», «macOS», «gRPC», «PostgreSQL», «Kubernetes», «Ceph RBD». Числа оформляйте единообразно: «5\u202f000 RPS», «p95 35\u202fмс», «99,95% SLA».", "Рассмотрите коррекцию зарплаты: либо «по договоренности», либо вилка по рынку Москвы/СПб/релокейта для повышения конверсии откликов.", "Соберите 2 версии резюме: 1) Lead/Principal Backend (фокус на инженерии, метриках производительности и надежности), 2) Platform/CTO‑трек (фокус на стратегии, бюджете, roadmap, найме, процессах).", "Раскройте вклад в архитектурный комитет: «инициировал 6 ADR, внедрил RFC‑процесс, стандартизировал логирование/трейсинг (OpenTelemetry), сократил время согласования архитектуры с 4 до 1,5 недель».", "Для безопасности добавьте: «секреты в Vault, KMS, rotation, mTLS между сервисами (Istio/Envoy), policy‑as‑code (OPA/Gatekeeper)» — если применимо; это усилит профиль."], "sections": {"Опыт работы": 9, "Достижения и метрики": 7, "Навыки/Ключевые слова": 6, "Лидерство и управление": 8, "Образование": 8, "Сертификаты/Хакатоны": 7, "Языки": 7, "Контакты и ссылки": 6, "Форматирование/ATS-совместимость": 4, "Орфография и стиль": 4, "Фокус и позиционирование": 7}}'
    )

    raw_str = remove_control_characters_re(raw_str)

    json_str = json_repair.loads(raw_str)
    print(json_str)

    TELEGRAM_BOT_TOKEN = os.environ.get("TELEGRAM_BOT_TOKEN", "")
    if not TELEGRAM_BOT_TOKEN:
        raise RuntimeError("TELEGRAM_BOT_TOKEN is not set")

    bot = Bot(token=TELEGRAM_BOT_TOKEN)
    message = Message(message_id=-1,
        date=datetime.now(),
        chat=types.Chat(id=537273517, type="private"),
    ).as_(bot)

    details = AnalysisDetail.model_validate_json("""
     {"prompt": "", "ok": true, "raw": "",  "score": 78,  "strengths": [    "Сильный технический стек: актуальные технологии (Python 3, FastAPI, async, Docker, Kubernetes, Kafka, Redis, MongoDB, PostgreSQL, MyPy) — хорошо подходит на роль Lead Python Backend.",    "Наличие измеримых достижений: «сервис имеет порядка 5_000 RPS», «оптимизировал Import/Export — скорость в 5 раз» — это ценно для HR и тех. лидов.",    "Опыт выступлений на конференциях и ссылки на записи — подтверждает публичную экспертизу и умение доносить технические идеи.",    "Командная и архитектурная роль: член архитектурного комитета, руководите backend-разработчиками и QA — соответствует вакансии Lead."  ],  "problems": [    "Наличие служебных артефактов и мусора: в начале файла видны «hh.ru», в тексте попадаются битые вставки «si=3FJszjmqBt0BTH6R» и разрывы строк — портит первое впечатление.",    "Отсутствует короткое summary/шапка (2–3 строки) с ключевыми метриками и профилем. Сейчас заголовок есть, но нет компактного elevator pitch.",    "Нечёткое количественное описание руководства: нет размера команды (сколько человек), зоны ответственности (кол-во сервисов, пользователей/клиентов, кластеры/нод), нет KPI/влияния на бизнес.",    "Неконсистентные и неполные навыки: в списке навыков нет уровней для многих ключевых технологий и отсутствуют важные ключевые слова для ATS (terraform/helm/monitoring/SRE/CI/CD/pytest/REST/gRPC).",    "Фрагменты текста плохо отформатированы: много переносов, непоследовательное использование пунктов и эмодзи, мешает быстрому просмотру 30 секунд.",    "Некоторые фразы расплывчаты и/или с орфографией: «Приемущетсвенно пишу на Python» (опечатка), «Разработал сервис аутентификация пользователей» (грамматика).",    "Ссылки на YouTube вставлены как длинные URL в теле описания опыта — лучше вынести в раздел \'Публикации/Доклады\' и дать читабельные подписи.",    "Образование оформлено хаотично: два блока с 2023 и 2021 без чёткой привязки к степени/году окончания — вызывает вопросы у HR/ATS."  ],  "actions": [    "Убрать служебные артефакты и мусор: удалить «hh.ru» сверху и строки «si=...», убрать лишние переносы и символы. Замените фразу «si=3FJszjmqBt0BTH6R» на ничего (удалить).",    "Добавить краткое summary (2–3 предложения) под заголовком. Пример: «Lead Python Developer с 8+ лет опыта в backend и облачных платформах. Руководил командой из 6–10 разработчиков, запускал сервисы с нагрузкой до 5000 RPS, увеличивал throughput и снижал IO‑операции в 5x. Специализация: масштабируемые сервисы, Kubernetes-as-a-Service, безопасность межсервисной аутентификации.»",    "Указать конкретные метрики и размер команды в описаниях. Примеры строк для замены/добавления: заменить «Руковожу командой backend разработчиков и QA» на «Руковожу командой из 6 backend-разработчиков и 2 QA: планирование спринтов, code review, повышение покрытии тестами с 40% до 75% и снижение количества production-ревёрсов на 30%». Если точные цифры неизвестны — добавить запрос в примечание: «укажите количество человек/метрики» при доработке.",    "Исправить и конкретизировать достижение про Service Mesh. Замените «Разработал высоконагруженный Service Mesh сервис... На данный момент сервис имеет порядка 5_000 RPS» на «Разработал Service Mesh для аутентификации/авторизации сервисов — 5000 RPS, снизил число инцидентов аутентификации на X% и обеспечил централизацию политик коммуникации (опишите, пожалуйста, % или число инцидентов до/после)».",    "Убрать ошибки и стилистически выровнять пункты. Замените «Приемущетсвенно пишу на Python» на «Преимущественно пишу на Python (3.10+) с применением типизации (MyPy)»; заменить «Разработал сервис аутентификация пользователей» на «Разработал сервис централизованной аутентификации пользователей (token-based, OIDC/Sessions) — убрал использование пользовательских секретов в сервисах».",    "Реформатировать раздел «Навыки»: разделить по категориям (Языки, Backend/Frameworks, БД, Infrastructure, DevOps, Testing, Tools) и указать уровень (Expert/Advanced/Intermediate). Добавить ключевые слова для ATS: Terraform, Helm, Prometheus, Grafana, CI/CD (GitHub Actions, GitLab CI), pytest, REST, gRPC, SRE/observability.",    "Вынести конференции и видео в отдельный блок \'Публикации и выступления\' с подписью: «PyCon Russia 2025 — тема: <тема>, ссылка»; не вставлять длинные URL в тело опыта.",    "Упорядочить образование и сертификаты: указать степень, факультет, годы начала и окончания. Пример: «Магистр, СПбУНИТМО, 2019–2023, Специальность: Системное и прикладное ПО».",    "Упомянуть результаты, влияющие на бизнес/операции: например, «оптимизация Import/Export — сократил IO на X% и снизил стоимость хранения/трафика на Y%»; если точные цифры неизвестны — добавить задачу по сбору данных/оценке влияния.",    "Убрать/сократить персональные детали, которые не нужны для ATS (дата рождения), и оставить релевантную личную информацию: контакты, GitHub, готовность к переезду/командировкам."  ],  "sections": {    "contacts": 8,    "title_summary": 4,    "experience": 7,    "achievements": 7,    "skills": 6,    "education": 5,    "certificates_publications": 6,    "formatting_readability": 4,    "ATS_friendliness": 5  }}
""")
    # await send_ok_message(details, message)

if __name__ == "__main__":
    asyncio.run(main())
